<link rel="import" href="math-ui-controller.html" />
<link rel="import" href="math-ui-eqn-menu.html" />
<link rel="import" href="math-ui-plain.html" />
<link rel="import" href="math-ui-mml.html" />

<style>
    math-ui {
        position: relative;
        border: 3px solid transparent;
        padding: 1px;
        margin: -4px;  /* -(border-width + padding) */
        outline: none;
        cursor: pointer;
        display: inline-block;
    }
    math-ui[display="block"] {
        display: block;
        text-align: center;
    }
    math-ui:hover, math-ui.highlight {
        border: 3px solid #afbfff;
    }
    math-ui:focus {
        border: 3px solid #4f9fcf;
    }
    dialog.math-ui-zoom {
        position: absolute;
        background-color: white;
        color: black;
        padding: 0 0.5em;
        border: 3px solid black;
        margin: 0;
        font-size: 200%;
    }
    dialog.math-ui-source {
        width: 40em;
    }
    dialog.math-ui.math-ui-source > .content {
        color: #000;
        padding: 0;
    }
    dialog.math-ui-source .sourcetypes {
        font-size: 80%;
    }
    dialog.math-ui-source .sourcetypes span {
        display: inline-block;
        background-color: #d6e3e7;
        padding: 0.5em 0;
        width: 6em;
        text-align: center;
    }
    dialog.math-ui-source .sourcetypes span[selected] {
        font-weight: bold;
    }
    dialog.math-ui-source .sourcetypes span:hover {
        background-color: #eaf1f3;
        cursor: pointer;
    }
    dialog.math-ui-source pre {
        width: 100%;
        height: 20em;
        margin: 0;
        padding: 0 0 0 1em;
        box-sizing: border-box;
        overflow: scroll;
    }
</style>

<template id="math-ui-zoom">
    <dialog class="math-ui-zoom"></dialog>
</template>

<template id="math-ui-source">
    <dialog class="math-ui math-ui-source">
        <div class="header">Equation Source</div>
        <div class="content">
            <div class="sourcetypes">
            </div>
            <pre>
            </pre>
        </div>
    </dialog>
</template>

<script>
(function () {
    'use strict';

    var importDoc = (document._currentScript ? document._currentScript : document.currentScript).ownerDocument;
    var mathUIDialog = document.createElement('math-ui-dialog');
    var element = Object.create(HTMLElement.prototype);
    var controller;

    function async(fn) {
        requestAnimationFrame(fn);
        //setTimeout(fn, 0);
    }

    function getHandlerMethod(elem, method) {
        var fn = elem.handler[method];
        return fn ? fn.bind(elem.ownHandler ? elem : elem.handler) : null;
    }

    function genericCloner(dst, src) {
        var node = src.firstChild;
        while (node) {
            dst.appendChild(node.cloneNode(true));
            node = node.nextSibling;
        }
    }

    element.domReady = function () {
        if (!this.handler) {
            var mathNode = this.firstElementChild;
            if (mathNode && mathNode.tagName === 'math') {
                this.handler = document.createElement('math-ui-mml');
                this.ownHandler = true;
            } else if (mathNode && mathNode.getSourceTypes) {
                this.handler = mathNode;
            } else {
                this.handler = document.createElement('math-ui-plain');
                this.ownHandler = true;
            }
        }
        if (!this.hasAttribute('display') && this.handler.getDisplay) {
            var display = getHandlerMethod(this, 'getDisplay')();
            if (display)
                this.setAttribute('display', display);
        }
    }

    element.showMenu = function () {
        this.menu = document.createElement('math-ui-eqn-menu');
        (this.shadowRoot ? this.shadowRoot : this).appendChild(this.menu);
        this.menu.style.top = (this.offsetHeight - 3) + 'px';
    };

    element.zoomAction = function () {
        var tmpl = importDoc.querySelector('#math-ui-zoom');
        var node = document.importNode(tmpl.content, true);
        var dialog = node.querySelector('dialog');
        var cloner = getHandlerMethod(this, 'clonePresentation');
        if (cloner)
            cloner(dialog);
        else
            genericCloner(dialog, this.ownHandler ? this : this.handler)
        dialog.style.left = this.offsetLeft + 'px';
        dialog.style.top = this.offsetTop + 'px';
        mathUIDialog.showModal(dialog);
    };

    function sourceToString(src) {
        var st;
        if (typeof src === 'string')
            st = src;
        else if (src.nodeType === Node.ELEMENT_NODE)
            st = src.outerHTML;
        else if (src.nodeType === Node.TEXT_NODE)
            st = src.nodeValue;
        else if (src.nodeType === Node.COMMENT_NODE)
            st = ''; //'<!--' + src.nodeValue + '-->';
        else if (src.nodeType === Node.DOCUMENT_FRAGMENT_NODE)
            st = Array.prototype.map.call(src.childNodes, sourceToString).join('');
        else {
            console.log(src);
            throw "Unsupported source type";
        }
        return st.trim();
    }

    function sourceViewer(el, dialog) {
        var sourcetypes = getHandlerMethod(el, 'getSourceTypes')();
        var sourcetypesEl = dialog.querySelector('.sourcetypes');
        var sourcetypeButtons = [];
        var sourceIndex = 0;
        function update() {
            sourcetypeButtons.forEach(function (item, index) {
                if (index === sourceIndex)
                    item.setAttribute('selected', '');
                else
                    item.removeAttribute('selected');
            });
            var source = getHandlerMethod(el, 'getSource')(sourcetypes[sourceIndex]);
            dialog.querySelector('pre').textContent = source == null ? '' : sourceToString(source);
        }
        function keydown(ev) {
            if (ev.keyCode === 39)
                sourceIndex = (sourceIndex + 1) % sourcetypes.length;
            else if (ev.keyCode === 37)
                sourceIndex = (sourceIndex + sourcetypes.length - 1) % sourcetypes.length;
            else
                return;
            update();
        }
        sourcetypes.forEach(function (type, index) {
            var span = document.createElement('span');
            span.appendChild(document.createTextNode(type));
            sourcetypesEl.appendChild(span);
            sourcetypeButtons.push(span);
        });
        update();
        document.addEventListener('keydown', keydown);
        mathUIDialog.showModal(dialog, function (ev) {
            var btnIndex = sourcetypeButtons.indexOf(ev.target);
            if (btnIndex >= 0) {
                sourceIndex = btnIndex;
                update();
            }
            return ev.target === dialog;
        }, function () {
            document.removeEventListener('keydown', keydown);
        });
    }

    element.sourceAction = function () {
        if (getHandlerMethod(this, 'getSourceTypes')().length === 0) {
            alert('No sources available for Equation ' + this.eqnId);
            return;
        }
        var tmpl = importDoc.querySelector('#math-ui-source');
        var node = document.importNode(tmpl.content, true);
        var dialog = node.querySelector('dialog');
        dialog.querySelector('.header').innerHTML = 'Equation ' + this.eqnId + ' Source';
        sourceViewer(this, dialog);
    };

    element.searchAction = function () {
        alert('search');
    };

    element.shareAction = function () {
        alert('share');
    };

    element.showDashboard = function () {
        controller.showMenu();
    };

    element.removeMenu = function () {
        var parent = this.shadowRoot ? this.shadowRoot : this;
        Array.prototype.forEach.call(parent.querySelectorAll('math-ui-eqn-menu'), function (el) {
            parent.removeChild(el);
        });
        this.menu = null;
    };

    element.createdCallback = function () {
        this.tabIndex = 0;
        if (this.hasAttribute('use')) {
            this.handler = document.createElement(this.getAttribute('use'));
            this.ownHandler = true;
            if (this.handler.createdCallback)
                this.handler.createdCallback.call(this);
        }
    };

    element.attachedCallback = function () {
        if (!controller)
            controller = document.createElement('math-ui-controller');
        this.eqnId = controller.addItem(this);
        this.menu = null;
        if (this.handler && this.handler.attachedCallback)
            this.handler.attachedCallback.call(this);
        var self = this;
        this.addEventListener('focus', function (ev) { self.showMenu(); }, false);
        this.addEventListener('blur', function (ev) { self.removeMenu(); }, false);
        this.addEventListener('keydown', function (ev) {
            if (!self.menu) return;
            if (ev.keyCode === 39) self.menu.navNext();
            else if (ev.keyCode === 37) self.menu.navPrev();
            else if (ev.keyCode === 13) async(function () { self.menu.triggerSelection(); });
            else if (ev.keyCode === 27) self.blur();
            //else console.log('keydown', ev.keyCode);
        }, false);
        async(this.domReady.bind(this));
    };

    document.registerElement('math-ui', {prototype: element});

})();
</script>
