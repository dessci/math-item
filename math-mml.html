<link rel="import" href="math-ui.html">
<link rel="import" href="mathjax-loader.html">

<script>
(function() {
    'use strict';

    var mathjax;

    function update(jax, math) {
        var firstTypeset = !jax.hasAttribute('type');
        jax.type = 'math/mml';
        if (math)
            jax.appendChild(math.cloneNode(true));
        firstTypeset ? mathjax.typeset(jax) : mathjax.reprocess(jax);
    }

    var element = Object.create(HTMLElement.prototype);

    element.createdCallback = function () {
        if (!mathjax)
            mathjax = document.createElement('mathjax-loader');
        var sdom = this.createShadowRoot();
        var script = document.createElement('script');
        sdom.appendChild(script);
        this._jax = script;
    };

    element.attachedCallback = function () {
        update(this._jax, this.querySelector('math'));
    };

    element.getDisplay = function () {
        var mathNode = this.querySelector('math');
        return mathNode ? mathNode.getAttribute('display') : null;
    };

    element.getSourceTypes = function () {
        return ['application/mathml+xml'];
    };

    document.registerElement('math-mml', {prototype: element});
})();
</script>
