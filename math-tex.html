<link rel="import" href="mathjax-loader.html">

<script>
(function() {
    'use strict';

    var mathjax;

    function update(el, mode, math) {
        var firstTypeset = !el._jax.hasAttribute('type');
        el._jax.type = mode === 'display' ? 'math/tex; mode=display' : 'math/tex';
        if (math)
            el._jax.textContent = math;
        function addMathMLSource(mml) {
            el.sourceTypes.push(['MathML', mml]);
        }
        function callback() {
            var jx = MathJax.Hub.getAllJax(el.shadowRoot)[0];
            el.sourceTypes = [['LaTeX', jx.originalText]];
            if (jx.root.toMathML) {
                try {
                    addMathMLSource(jx.root.toMathML(''));
                } catch (err) {
                    if (!err.restart) { throw err; }
                    return MathJax.Callback.After([toMathML, jx, addMathMLSource], err.restart);
                }
            }
        }
        firstTypeset ? mathjax.typeset(el._jax, callback) : mathjax.reprocess(el._jax, callback);
    }

    var element = Object.create(HTMLElement.prototype);

    element.createdCallback = function () {
        if (!mathjax)
            mathjax = document.createElement('mathjax-loader');
        var root = this.createShadowRoot();
        var script = document.createElement('script');
        root.appendChild(script);
        this._jax = script;
        this.sourceTypes = [];
    };

    element.attachedCallback = function () {
        update(this, this.getAttribute('mode'), this.textContent);
    };

    element.attributeChangedCallback = function (attr, oldVal, newVal) {
        if (attr === 'mode')
            update(this, newVal);
    };

    element.getDisplay = function () {
        return this.getAttribute('mode') === 'display' ? 'block' : 'inline';
    };

    element.getSourceTypes = function () {
        return this.sourceTypes.map(function (item) { return item[0]; });
    };

    element.getSource = function (type) {
        var sourceMatch = this.sourceTypes.filter(function (item) {
            return type === item[0];
        });
        return sourceMatch.length ? sourceMatch[0][1] : null;
    };

    element.clonePresentation = function (dest) {
        var clone = document.createElement('math-tex');
        if (this.hasAttribute('mode'))
            clone.setAttribute('mode', this.getAttribute('mode'));
        clone.appendChild(document.createTextNode(this.textContent));
        dest.appendChild(clone);
    };

    document.registerElement('math-tex', {prototype: element});
})();
</script>
