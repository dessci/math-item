<link rel="import" href="math-ui-controller.html">
<link rel="import" href="math-ui-eqn-menu.html">
<link rel="import" href="math-ui-plain.html">
<link rel="import" href="math-ui-mml.html">

<style>
    math-ui {
        position: relative;
        border: 3px solid transparent;
        border-radius: 5px;
        padding: 1px;
        margin: -4px;  /* -(border-width + padding) */
        outline: none;
        cursor: pointer;
        display: inline-block;
    }
    math-ui[display="block"] {
        display: block;
        text-align: center;
    }
    math-ui:hover, math-ui.highlight {
        border: 3px solid #afbfff;
    }
    math-ui:focus {
        border: 3px solid #4f9fcf;
    }
</style>

<script>
(function () {
    'use strict';

    var importDoc = (document._currentScript ? document._currentScript : document.currentScript).ownerDocument;
    var mathUIDialog = document.createElement('math-ui-dialog');
    var element = Object.create(HTMLElement.prototype);
    var controller;

    element.domReady = function () {
        if (!this.handler) {
            var mathNode = this.firstElementChild;
            if (mathNode && mathNode.tagName === 'math') {
                this.handler = document.createElement('math-ui-mml');
                this.ownHandler = true;
            } else if (mathNode && mathNode.getSourceTypes) {
                this.handler = mathNode;
            } else {
                this.handler = document.createElement('math-ui-plain');
                this.ownHandler = true;
            }
        }
        if (!this.hasAttribute('display') && this.handler.getDisplay) {
            var display = this.ownHandler ? this.handler.getDisplay.call(this) : this.handler.getDisplay();
            if (display)
                this.setAttribute('display', display);
        }
    }

    element.showMenu = function () {
        var menu = document.createElement('math-ui-eqn-menu');
        (this.shadowRoot ? this.shadowRoot : this).appendChild(menu);
        menu.style.top = (this.offsetHeight - 3) + 'px';
        menu.setParent(this);
    };

    element.removeMenu = function () {
        var parent = this.shadowRoot ? this.shadowRoot : this;
        Array.prototype.forEach.call(parent.querySelectorAll('math-ui-eqn-menu'), function (el) {
            parent.removeChild(el);
        });
    };

    element.createdCallback = function () {
        this.tabIndex = 0;
        if (this.hasAttribute('use')) {
            this.handler = document.createElement(this.getAttribute('use'));
            this.ownHandler = true;
            if (this.handler.createdCallback)
                this.handler.createdCallback.call(this);
        }
    };

    element.attachedCallback = function () {
        if (!controller)
            controller = document.createElement('math-ui-controller');
        this.eqnId = controller.addItem(this);
        if (this.handler && this.handler.attachedCallback)
            this.handler.attachedCallback.call(this);
        var self = this;
        function focus(ev) {
            self.showMenu();
        }
        function blur(ev) {
            self.removeMenu();
        }
        this.addEventListener('focus', focus, false);
        this.addEventListener('blur', blur, false);
        requestAnimationFrame(this.domReady.bind(this));
    };

    document.registerElement('math-ui', {prototype: element});

})();
</script>
