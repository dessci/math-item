<link rel="import" href="math-ui-controller.html">
<link rel="import" href="math-ui-dialog.html" />
<link rel="import" href="math-ui-plain.html">
<link rel="import" href="math-ui-mml.html">

<style>
    math-ui {
        position: relative;
        border: 0.1em solid transparent;
        border-radius: 0.2em;
        padding: 0.1em;
        margin: -0.3em;
        outline: none;
        cursor: pointer;
        display: inline-block;
    }
    math-ui[display="block"] {
        display: block;
        text-align: center;
    }
    math-ui:hover, math-ui.highlight {
        border: 0.1em solid #afbfff;
    }
    math-ui:focus {
        border: 0.1em solid #4f9fcf;
    }
    dialog.math-ui.item-menu {
        width: 15em;
    }
</style>

<template>
    <dialog class="math-ui item-menu">
        <div class="header">Equation item</div>
        <div class="content">
            <button>View Source</button>
            <button>Search</button>
            <button>Share</button>
            <button>Florian Dashboard</button>
        </div>
        </div>
    </dialog>
</template>

<script>
(function () {
    'use strict';

    var importDoc = (document._currentScript ? document._currentScript : document.currentScript).ownerDocument;
    var mathUIDialog = document.createElement('math-ui-dialog');
    var element = Object.create(HTMLElement.prototype);
    var controller;

    element.domReady = function () {
        if (!this.handler) {
            var mathNode = this.firstElementChild;
            if (mathNode && mathNode.tagName === 'math') {
                this.handler = document.createElement('math-ui-mml');
                this.ownHandler = true;
            } else if (mathNode && mathNode.getSourceTypes) {
                this.handler = mathNode;
            } else {
                this.handler = document.createElement('math-ui-plain');
                this.ownHandler = true;
            }
        }
        if (!this.hasAttribute('display') && this.handler.getDisplay) {
            var display = this.ownHandler ? this.handler.getDisplay.call(this) : this.handler.getDisplay();
            if (display)
                this.setAttribute('display', display);
        }
    }

    element.showMenu = function () {
        var tmpl = importDoc.querySelector('template');
        var node = document.importNode(tmpl.content, true);
        if (this.eqnId)
            node.querySelector('.header').innerHTML = 'Equation ' + this.eqnId;
        var buttons = node.querySelectorAll('button');
        var dialog = mathUIDialog.showModal(node);
        function showDashboard(ev) {
            ev.stopPropagation();
            dialog.close();
            controller.showMenu();
        }
        buttons[3].addEventListener('click', showDashboard);
    };

    element.createdCallback = function () {
        this.tabIndex = 0;
        if (this.hasAttribute('use')) {
            this.handler = document.createElement(this.getAttribute('use'));
            this.ownHandler = true;
            if (this.handler.createdCallback)
                this.handler.createdCallback.call(this);
        }
    };

    element.attachedCallback = function () {
        if (!controller)
            controller = document.createElement('math-ui-controller');
        this.eqnId = controller.addItem(this);
        if (this.handler && this.handler.attachedCallback)
            this.handler.attachedCallback.call(this);
        var self = this;
        function showMenu(ev) {
            ev.stopPropagation();
            self.showMenu();
        }
        this.addEventListener('click', showMenu);
        requestAnimationFrame(this.domReady.bind(this));
    };

    document.registerElement('math-ui', {prototype: element});

})();
</script>
