<link rel="import" href="math-ui-controller.html">
<link rel="import" href="math-ui-plain.html">
<link rel="import" href="math-ui-mml.html">

<style>
math-ui {
    position: relative;
    border: 0.2em solid transparent;
    border-radius: 0.5em;
    padding: 0.1em;
    margin: -0.3em;
    outline: none;
    cursor: pointer;
    display: inline-block;
}
math-ui[display="block"] {
    display: block;
    text-align: center;
}
math-ui:hover {
    border: 0.2em solid #afbfff;
}
math-ui:focus {
    border: 0.2em solid #4f9fcf;
}
</style>

<script>
(function() {

    var element = Object.create(HTMLElement.prototype);
    var controller;

    element.domReady = function () {
        if (!this.handler) {
            var mathNode = this.firstElementChild;
            if (mathNode && mathNode.tagName === 'math') {
                this.handler = document.createElement('math-ui-mml');
                this.ownHandler = true;
            } else if (mathNode && mathNode.getSourceTypes) {
                this.handler = mathNode;
            } else {
                this.handler = document.createElement('math-ui-plain');
                this.ownHandler = true;
            }
        }
        if (!this.hasAttribute('display') && this.handler.getDisplay) {
            var display = this.ownHandler ? this.handler.getDisplay.call(this) : this.handler.getDisplay();
            if (display)
                this.setAttribute('display', display);
        }
    }

    element.createdCallback = function () {
        this.tabIndex = 0;
        if (this.hasAttribute('use')) {
            this.handler = document.createElement(this.getAttribute('use'));
            this.ownHandler = true;
            if (this.handler.createdCallback)
                this.handler.createdCallback.call(this);
        }
    };

    element.attachedCallback = function () {
        if (!controller)
            controller = document.createElement('math-ui-controller');
        controller.addItem(this);
        if (this.handler && this.handler.attachedCallback)
            this.handler.attachedCallback.call(this);
        requestAnimationFrame(this.domReady.bind(this));
    };

    document.registerElement('math-ui', {prototype: element});

})();
</script>
