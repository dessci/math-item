<template>
    <style>
        :host {
            position: absolute;
            left: 0;
            top: 0;
            font-family: sans-serif;
            font-size: 80%;
            white-space: nowrap;
            z-index: 99999;
        }
        .header {
            background-color: #4f7dc9;
            color: white;
            padding: 0.5em;
        }
        .container {
            margin: 0;
            padding: 0;
            display: inline-block;
        }
        .item {
            display: inline-block;
            background-color: #d6e3e7;
            padding: 0.5em 0;
            width: 6em;
            text-align: center;
        }
        .item[selected] {
            font-weight: bold;
        }
        .item:hover {
            background-color: #eaf1f3;
        }
    </style>
    <span class="header">Equation</span><span class="container"><span class="item">Zoom</span><span class="item">Source</span><span class="item">Search</span><span class="item">Share</span><span class="item">Dashboard</span></span>
</template>

<script>
(function() {
    'use strict';

    var actions = ['zoomAction', 'sourceAction', 'searchAction', 'shareAction', 'showDashboard'];

    // inspired by how Polymer invokes domReady callbacks
    function async(fn) {
        requestAnimationFrame(fn);
        //setTimeout(fn, 0);
    }

    function select(menu, index) {
        var items = menu.shadowRoot.querySelectorAll('.item');
        Array.prototype.forEach.call(items, function (item) {
            item.removeAttribute('selected');
        });
        items[index].setAttribute('selected', '');
        menu.selectedIndex = index;
    }

    function getOwner(menu) {
        var owner = menu.parentNode;
        while (owner) {
            if (owner.nodeType === Node.ELEMENT_NODE) {
                if (owner.localName.toLowerCase() === 'math-ui')
                    return owner;
                owner = owner.parentNode;
            } else
                owner = owner.host ? owner.host : null;
        }
        return owner;
    }

    var importDoc = (document._currentScript ? document._currentScript : document.currentScript).ownerDocument;
    var element = Object.create(HTMLElement.prototype);

    element.createdCallback = function () {
        var tmpl = importDoc.querySelector('template');
        var frag = document.importNode(tmpl.content, true);
        if (window.WebComponents && WebComponents.ShadowCSS) {
            var style = frag.querySelector('style');
            frag.removeChild(style);
            var cssText = WebComponents.ShadowCSS.shimCssText(style.textContent, 'math-ui-eqn-menu');
            WebComponents.ShadowCSS.addCssToDocument(cssText);
        }
        this.createShadowRoot().appendChild(frag);
        select(this, 0);
    };

    element.attachedCallback = function () {
        var owner = getOwner(this);
        if (owner && owner.eqnId)
            this.shadowRoot.querySelector('span').innerHTML = 'Equation ' + owner.eqnId;
        var self = this;
        this.shadowRoot.addEventListener('click', function (ev) {
            var items = this.querySelectorAll('.item');
            var index = Array.prototype.indexOf.call(items, ev.target);
            if (index >= 0)
                select(self, index);
            async(function () { self.triggerSelection(); });
        }, false);
    };

    element.triggerSelection = function () {
        var owner = getOwner(this);
        if (!owner) return;
        owner.blur();
        owner[actions[this.selectedIndex]]();
    };

    element.navNext = function () {
        select(this, (this.selectedIndex + 1) % 5);
    };

    element.navPrev = function () {
        select(this, (this.selectedIndex + 5 - 1) % 5);
    };

    document.registerElement('math-ui-eqn-menu', { prototype: element });

})();
</script>
